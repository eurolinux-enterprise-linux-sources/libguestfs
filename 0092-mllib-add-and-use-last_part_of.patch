From 058d9865c07a0dfaf8ea7dea3d7bf4306ae88609 Mon Sep 17 00:00:00 2001
From: Pino Toscano <ptoscano@redhat.com>
Date: Wed, 1 Jul 2015 14:35:31 +0200
Subject: [PATCH 092/118] mllib: add and use last_part_of

Collect this small snippet to get the part of a string after the last
occurrency of a character; replace with it the current snippets doing
the same.

Should be just code motion.

(cherry picked from commit a614f3451d1e2cc4f29b1bc7f0d88519c432b2c8)
---
 mllib/common_utils.ml                     | 7 +++++++
 sysprep/sysprep_operation_user_account.ml | 7 +++++--
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/mllib/common_utils.ml b/mllib/common_utils.ml
index 6b1352e..43be2c9 100644
--- a/mllib/common_utils.ml
+++ b/mllib/common_utils.ml
@@ -438,3 +438,10 @@ let qemu_input_filename filename =
     "./" ^ filename
   else
     filename
+
+(** Return the last part of a string, after the specified separator. *)
+let last_part_of str sep =
+  try
+    let i = String.rindex str sep in
+    Some (String.sub str (i+1) (String.length str - (i+1)))
+  with Not_found -> None
diff --git a/sysprep/sysprep_operation_user_account.ml b/sysprep/sysprep_operation_user_account.ml
index b44fbfb..b394296 100644
--- a/sysprep/sysprep_operation_user_account.ml
+++ b/sysprep/sysprep_operation_user_account.ml
@@ -44,8 +44,11 @@ let user_account_perform g root =
           changed := true;
           g#aug_rm userpath;
           let username =
-            let i = String.rindex userpath '/' in
-            String.sub userpath (i+1) (String.length userpath -i-1) in
+            match last_part_of userpath '/' with
+            | Some x -> x
+            | None ->
+              eprintf "virt-sysprep: user-accounts: missing '/' in %s\n" userpath;
+              exit 1 in
           (* XXX Augeas doesn't yet have a lens for /etc/shadow, so the
            * next line currently does nothing, but should start to
            * work in a future version.
-- 
2.7.4

