From 31b5db7fe469e2b44258469360af8e68b9726578 Mon Sep 17 00:00:00 2001
From: "Richard W.M. Jones" <rjones@redhat.com>
Date: Sat, 31 Aug 2013 22:48:04 +0100
Subject: [PATCH 077/117] rescue: Use cachemode "unsafe" for the virt-rescue
 --scratch option.

(cherry picked from commit 3f0748f1fc64e42517c0d4535c27b1f32da86023)
---
 fish/options.c       | 9 ++++++++-
 fish/options.h       | 1 +
 rescue/virt-rescue.c | 1 +
 3 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/fish/options.c b/fish/options.c
index 34602a5..1455420 100644
--- a/fish/options.c
+++ b/fish/options.c
@@ -63,6 +63,10 @@ add_drives (struct drv *drv, char next_drive)
         ad_optargs.bitmask |= GUESTFS_ADD_DRIVE_OPTS_FORMAT_BITMASK;
         ad_optargs.format = drv->a.format;
       }
+      if (drv->a.cachemode) {
+        ad_optargs.bitmask |= GUESTFS_ADD_DRIVE_OPTS_CACHEMODE_BITMASK;
+        ad_optargs.cachemode = drv->a.cachemode;
+      }
 
       r = guestfs_add_drive_opts_argv (g, drv->a.filename, &ad_optargs);
       if (r == -1)
@@ -175,7 +179,10 @@ free_drives (struct drv *drv)
   free (drv->device);
 
   switch (drv->type) {
-  case drv_a: /* a.filename and a.format are optargs, don't free them */ break;
+  case drv_a:
+    /* a.filename and a.format are optargs, don't free them */
+    /* a.cachemode is a static string, so don't free it */
+    break;
   case drv_d: /* d.filename is optarg, don't free it */ break;
 #if COMPILING_GUESTFISH
   case drv_N:
diff --git a/fish/options.h b/fish/options.h
index f7afc9c..97337ef 100644
--- a/fish/options.h
+++ b/fish/options.h
@@ -57,6 +57,7 @@ struct drv {
     struct {
       char *filename;       /* disk filename */
       const char *format;   /* format (NULL == autodetect) */
+      const char *cachemode;/* cachemode (NULL == default) */
     } a;
     struct {
       char *guest;          /* guest name */
diff --git a/rescue/virt-rescue.c b/rescue/virt-rescue.c
index ad520d5..ca0770f 100644
--- a/rescue/virt-rescue.c
+++ b/rescue/virt-rescue.c
@@ -569,6 +569,7 @@ add_scratch_disk (struct drv **drvs)
   drv->nr_drives = -1;
   drv->a.filename = filename;
   drv->a.format = "raw";
+  drv->a.cachemode = "unsafe"; /* because it's a scratch disk */
   drv->next = *drvs;
   *drvs = drv;
 }
-- 
2.5.0

