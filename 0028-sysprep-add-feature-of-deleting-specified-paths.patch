From 9b9152b9892c24396169d02d09a2f28514a375bd Mon Sep 17 00:00:00 2001
From: Wanlong Gao <gaowanlong@cn.fujitsu.com>
Date: Tue, 22 Oct 2013 16:17:25 +0800
Subject: [PATCH 028/102] sysprep: add feature of deleting specified paths

Signed-off-by: Wanlong Gao <gaowanlong@cn.fujitsu.com>
Signed-off-by: Richard W.M. Jones <rjones@redhat.com>
(cherry picked from commit e4c9212a8e9fe9c2a75ce5035a4c3bce53261018)
---
 po/POTFILES-ml                      |  1 +
 sysprep/Makefile.am                 |  1 +
 sysprep/sysprep_operation_delete.ml | 51 +++++++++++++++++++++++++++++++++++++
 3 files changed, 53 insertions(+)
 create mode 100644 sysprep/sysprep_operation_delete.ml

diff --git a/po/POTFILES-ml b/po/POTFILES-ml
index c375dd6..9b2ebe6 100644
--- a/po/POTFILES-ml
+++ b/po/POTFILES-ml
@@ -8,6 +8,7 @@ sysprep/sysprep_operation_blkid_tab.ml
 sysprep/sysprep_operation_ca_certificates.ml
 sysprep/sysprep_operation_crash_data.ml
 sysprep/sysprep_operation_cron_spool.ml
+sysprep/sysprep_operation_delete.ml
 sysprep/sysprep_operation_dhcp_client_state.ml
 sysprep/sysprep_operation_dhcp_server_state.ml
 sysprep/sysprep_operation_dovecot_data.ml
diff --git a/sysprep/Makefile.am b/sysprep/Makefile.am
index 8bea9fc..86abcc3 100644
--- a/sysprep/Makefile.am
+++ b/sysprep/Makefile.am
@@ -36,6 +36,7 @@ operations = \
 	ca_certificates \
 	crash_data \
 	cron_spool \
+	delete \
 	dhcp_client_state \
 	dhcp_server_state \
 	dovecot_data \
diff --git a/sysprep/sysprep_operation_delete.ml b/sysprep/sysprep_operation_delete.ml
new file mode 100644
index 0000000..7cf1c39
--- /dev/null
+++ b/sysprep/sysprep_operation_delete.ml
@@ -0,0 +1,51 @@
+(* virt-sysprep
+ * Copyright (C) 2013 Fujitsu Ltd.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ *)
+
+open Common_utils
+open Sysprep_operation
+open Common_gettext.Gettext
+
+module G = Guestfs
+
+let paths = ref []
+let add_paths path = paths := path :: !paths
+
+let path_perform g root =
+  let paths = List.rev !paths in
+  List.iter g#rm_rf paths;
+  []
+
+let op = {
+  defaults with
+    name = "delete";
+    enabled_by_default = true;
+    heading = s_"Delete specified files or directories";
+    pod_description = Some (s_"\
+Delete specified files or directories.
+
+Use the I<--delete> option to specify a path to remove.");
+    extra_args = [
+      ("--delete", Arg.String add_paths, s_"path" ^ " " ^ s_"File or directory to be removed on guest"),
+      s_"\
+Delete (recursively) the specified C<path> on guest.";
+    ];
+
+    perform_on_filesystems = Some path_perform;
+}
+
+let () = register_operation op
-- 
1.9.3

